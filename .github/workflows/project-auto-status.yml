name: Project Auto Status

on:
  issues:
    types: [opened, reopened, closed, labeled]
  pull_request:
    types: [opened, ready_for_review, synchronize, closed]
  workflow_dispatch:
  schedule:
    # daily reconcile at 06:00 UTC
    - cron: '0 6 * * *'

permissions:
  contents: read
  issues: write
  pull-requests: read

env:
  PROJECT_OWNER: Arkon-Meyer
  PROJECT_NUMBER: "2"

jobs:
  issue-events:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auth with PAT
        run: gh auth login --with-token <<< "${{ secrets.GH_PROJECT_TOKEN }}"

      - name: Decide target status for issue
        id: decide
        shell: bash
        run: |
          action="${{ github.event.action }}"
          title="${{ github.event.issue.title }}"
          label="${{ github.event.label.name || '' }}"
          target=""
          case "$action" in
            opened|reopened) target="To Do" ;;
            closed)          target="Done" ;;
            labeled)
              case "$label" in
                Phase0) target="To Do" ;;
                Phase1|Phase2) target="Backlog" ;;
              esac
            ;;
          esac
          echo "target=$target" >> "$GITHUB_OUTPUT"

      - name: Update Project Status (if decided)
        if: steps.decide.outputs.target != ''
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          TARGET_STATUS: ${{ steps.decide.outputs.target }}
        run: scripts/project-auto-status.sh

  pr-events:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auth with PAT
        run: gh auth login --with-token <<< "${{ secrets.GH_PROJECT_TOKEN }}"

      - name: Extract closing-issue numbers from PR body
        id: extract
        shell: bash
        run: |
          body="${{ github.event.pull_request.body || '' }}"
          issues="$(printf '%s' "$body" \
            | grep -Eio '(close[sd]?|fix(e[sd])?|resolve[sd]?) +([a-z0-9._-]+/[a-z0-9._-]+)?#([0-9]+)' \
            | sed -E 's/.*#([0-9]+)/\1/' \
            | tr '\n' ' ' \
            | sed -E 's/  */ /g' | sed -E 's/^ *| *$//g')"
          echo "issues=$issues" >> "$GITHUB_OUTPUT"

      - name: Move linked issues → In Progress (PR open/sync)
        if: github.event.action == 'opened' || github.event.action == 'ready_for_review' || github.event.action == 'synchronize'
        shell: bash
        run: |
          for n in ${{ steps.extract.outputs.issues }}; do
            ISSUE_NUMBER="$n" TARGET_STATUS="In Progress" scripts/project-auto-status.sh
          done

      - name: On PR closed → Done (merged) or To Do (not merged)
        if: github.event.action == 'closed'
        env:
          MERGED: ${{ github.event.pull_request.merged }}
        shell: bash
        run: |
          target="To Do"
          if [[ "$MERGED" == "true" ]]; then target="Done"; fi
          for n in ${{ steps.extract.outputs.issues }}; do
            ISSUE_NUMBER="$n" TARGET_STATUS="$target" scripts/project-auto-status.sh
          done

  reconcile:
    # runs for manual dispatch or on the daily cron to keep the board tidy
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Auth with PAT
        run: gh auth login --with-token <<< "${{ secrets.GH_PROJECT_TOKEN }}"
      - name: Reconcile board (titles → Status)
        run: scripts/project-set-status.sh
