# .github/workflows/project-auto-status.yml
name: Project Auto Status

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *"   # nightly reconcile (03:17 UTC)
  issues:
    types: [opened, reopened, closed, labeled]
  pull_request:
    types: [opened, ready_for_review, synchronize, closed]

# We use a PAT inside jobs, so repo permissions can stay minimal here
permissions:
  contents: read
  issues: write
  pull-requests: read

env:
  PROJECT_OWNER: Arkon-Meyer
  PROJECT_NUMBER: "2"

concurrency:
  group: project-auto-status-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # --- Manual / nightly full reconcile -------------------------------------
  reconcile:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auth with PAT
        env:
          GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
        run: gh auth login --with-token <<< "$GH_PROJECT_TOKEN"

      - name: Sanity (prints scopes)
        run: gh auth status -h github.com

      - name: Reconcile all items → set Status by phase
        env:
          PROJECT_OWNER: ${{ env.PROJECT_OWNER }}
          PROJECT_NUMBER: ${{ env.PROJECT_NUMBER }}
        run: scripts/project-set-status.sh

  # --- Issue event automation ----------------------------------------------
  issue-events:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auth with PAT
        env:
          GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
        run: gh auth login --with-token <<< "$GH_PROJECT_TOKEN"

      - name: Decide target status for issue
        id: decide
        shell: bash
        run: |
          action="${{ github.event.action }}"
          title="${{ github.event.issue.title }}"
          label="${{ github.event.label.name || '' }}"
          target=""
          case "$action" in
            opened|reopened) target="To Do" ;;
            closed)          target="Done" ;;
            labeled)
              case "$label" in
                Phase0) target="To Do" ;;
                Phase1|Phase2) target="Backlog" ;;
              esac
            ;;
          esac
          echo "target=$target" >> "$GITHUB_OUTPUT"

      - name: Update Project Status (if decided)
        if: steps.decide.outputs.target != ''
        env:
          GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          TARGET_STATUS: ${{ steps.decide.outputs.target }}
          PROJECT_OWNER: ${{ env.PROJECT_OWNER }}
          PROJECT_NUMBER: ${{ env.PROJECT_NUMBER }}
        run: scripts/project-auto-status.sh

  # --- PR event automation --------------------------------------------------
  pr-events:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auth with PAT
        env:
          GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
        run: gh auth login --with-token <<< "$GH_PROJECT_TOKEN"

      - name: Extract closing-issue numbers from PR body
        id: extract
        shell: bash
        run: |
          body="${{ github.event.pull_request.body || '' }}"
          issues="$(printf '%s' "$body" \
            | grep -Eio '(close[sd]?|fix(e[sd])?|resolve[sd]?) +([a-z0-9._-]+/[a-z0-9._-]+)?#([0-9]+)' \
            | sed -E 's/.*#([0-9]+)/\1/' \
            | tr '\n' ' ' \
            | sed -E 's/  */ /g' | sed -E 's/^ *| *$//g')"
          echo "issues=$issues" >> "$GITHUB_OUTPUT"

      - name: Move linked issues → In Progress (PR open/sync)
        if: github.event.action == 'opened' || github.event.action == 'ready_for_review' || github.event.action == 'synchronize'
        env:
          GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
          PROJECT_OWNER: ${{ env.PROJECT_OWNER }}
          PROJECT_NUMBER: ${{ env.PROJECT_NUMBER }}
        shell: bash
        run: |
          for n in ${{ steps.extract.outputs.issues }}; do
            ISSUE_NUMBER="$n" TARGET_STATUS="In Progress" scripts/project-auto-status.sh
          done

      - name: On PR closed → Done (merged) or To Do (not merged)
        if: github.event.action == 'closed'
        env:
          GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
          MERGED: ${{ github.event.pull_request.merged }}
          PROJECT_OWNER: ${{ env.PROJECT_OWNER }}
          PROJECT_NUMBER: ${{ env.PROJECT_NUMBER }}
        shell: bash
        run: |
          target="To Do"
          if [[ "$MERGED" == "true" ]]; then target="Done"; fi
          for n in ${{ steps.extract.outputs.issues }}; do
            ISSUE_NUMBER="$n" TARGET_STATUS="$target" scripts/project-auto-status.sh
          done
