name: Project Auto Status

on:
  issues:
    types: [opened, reopened, closed, labeled]
  pull_request:
    types: [opened, ready_for_review, synchronize, closed]
  workflow_dispatch:
  schedule:
    # Run daily at 07:00 UTC
    - cron: '0 7 * * *'

permissions:
  contents: read
  issues: write
  pull-requests: read

env:
  PROJECT_OWNER: Arkon-Meyer
  PROJECT_NUMBER: "2"

jobs:
  issue-events:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Handy: see scopes + who we are before auth
      - name: Debug auth (pre)
        run: |
          set -x
          gh --version
          gh auth status -h github.com || true

      - name: Auth with PAT
        env:
          GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
        run: |
          test -n "$GH_PROJECT_TOKEN" || { echo "::error::Missing secrets.GH_PROJECT_TOKEN"; exit 1; }
          gh auth login --with-token <<< "$GH_PROJECT_TOKEN"

      - name: Debug auth (post)
        run: gh auth status -h github.com || true

      - name: Update project status (issues)
        run: scripts/project-set-status.sh

  pr-events:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Debug auth (pre)
        run: |
          set -x
          gh --version
          gh auth status -h github.com || true
      - name: Auth with PAT
        env:
          GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
        run: |
          test -n "$GH_PROJECT_TOKEN" || { echo "::error::Missing secrets.GH_PROJECT_TOKEN"; exit 1; }
          gh auth login --with-token <<< "$GH_PROJECT_TOKEN"
      - name: Debug auth (post)
        run: gh auth status -h github.com || true
      - name: Update project status (PRs)
        run: scripts/project-set-status.sh

  reconcile:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Debug auth (pre)
        run: |
          set -x
          gh --version
          gh auth status -h github.com || true
      - name: Auth with PAT
        env:
          GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
        run: |
          test -n "$GH_PROJECT_TOKEN" || { echo "::error::Missing secrets.GH_PROJECT_TOKEN"; exit 1; }
          gh auth login --with-token <<< "$GH_PROJECT_TOKEN"
      - name: Debug auth (post)
        run: gh auth status -h github.com || true
      - name: Reconcile board (titles â†’ Status)
        run: scripts/project-set-status.sh
