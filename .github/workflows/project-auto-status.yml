name: Project Auto Status

on:
  issues:
    types: [opened, reopened, closed, labeled, unlabeled, edited]
  pull_request:
    types: [opened, ready_for_review, synchronize, closed]
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *' # daily @ 07:00 UTC

permissions:
  contents: read
  issues: write
  pull-requests: read

concurrency:
  group: project-auto-status-${{ github.ref || github.run_id }}
  cancel-in-progress: false

env:
  PROJECT_OWNER: Arkon-Meyer
  PROJECT_NUMBER: "2"
  GH_TOKEN: ${{ secrets.GH_PAT }}   # force PAT instead of ephemeral GITHUB_TOKEN

jobs:
  issue-events:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: gh version
        run: gh --version
      - name: Debug auth & validate PAT
        run: |
          echo "ðŸ”‘ Checking GitHub authentication"
          gh auth status -h github.com || true

          TOKEN="$(gh auth token)"
          echo "ðŸ”Ž Checking token scopes header..."
          SCOPES=$(curl -s -H "Authorization: token $TOKEN" https://api.github.com/user -i | awk -F': ' '/^x-oauth-scopes:/ {print $2}' | tr -d '\r')
          echo "x-oauth-scopes: ${SCOPES:-<none>}"
          echo "---"

          USER_LOGIN=$(curl -s -H "Authorization: token $TOKEN" https://api.github.com/user | jq -r .login)
          echo "ðŸ‘¤ Active user: $USER_LOGIN"

          if [ "$USER_LOGIN" != "Arkon-Meyer" ]; then
            echo "::error::Token is for '$USER_LOGIN' but expected 'Arkon-Meyer'."
            echo "::notice::To regenerate: Settings â†’ Developer settings â†’ Personal access tokens â†’ Fine-grained token"
            echo "::notice::Grant: repos (this repo), scopes: repo, project, workflow. Name it GH_PAT and add to repo secrets."
            exit 1
          fi

          echo "$SCOPES" | grep -qi 'project' || {
            echo "::error::Token missing 'project' scope."
            echo "::notice::To regenerate: create a fine-grained PAT with 'project' and 'repo' access, save as GH_PAT."
            exit 1
          }

      - name: Update project status (issues)
        env:
          DEBUG: ${{ inputs.debug || '' }}
        run: |
          chmod +x scripts/project-set-status.sh
          scripts/project-set-status.sh
      - name: Upload debug (optional)
        if: env.DEBUG == '1'
        uses: actions/upload-artifact@v4
        with:
          name: project-auto-status-debug-issues
          path: |
            debug/*.json
          if-no-files-found: ignore
          retention-days: 1

  pr-events:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: gh version
        run: gh --version
      - name: Debug auth & validate PAT
        run: |
          echo "ðŸ”‘ Checking GitHub authentication"
          gh auth status -h github.com || true

          TOKEN="$(gh auth token)"
          SCOPES=$(curl -s -H "Authorization: token $TOKEN" https://api.github.com/user -i | awk -F': ' '/^x-oauth-scopes:/ {print $2}' | tr -d '\r')
          USER_LOGIN=$(curl -s -H "Authorization: token $TOKEN" https://api.github.com/user | jq -r .login)
          echo "x-oauth-scopes: ${SCOPES:-<none>}"
          echo "ðŸ‘¤ Active user: $USER_LOGIN"

          if [ "$USER_LOGIN" != "Arkon-Meyer" ]; then
            echo "::error::Token is for '$USER_LOGIN' but expected 'Arkon-Meyer'."
            echo "::notice::To regenerate: Settings â†’ Developer settings â†’ Personal access tokens â†’ Fine-grained token"
            echo "::notice::Grant: repos (this repo), scopes: repo, project, workflow. Name it GH_PAT and add to repo secrets."
            exit 1
          fi

          echo "$SCOPES" | grep -qi 'project' || {
            echo "::error::Token missing 'project' scope."
            echo "::notice::To regenerate: create a fine-grained PAT with 'project' and 'repo' access, save as GH_PAT."
            exit 1
          }

      - name: Update project status (PRs)
        env:
          DEBUG: ${{ inputs.debug || '' }}
        run: |
          chmod +x scripts/project-set-status.sh
          scripts/project-set-status.sh
      - name: Upload debug (optional)
        if: env.DEBUG == '1'
        uses: actions/upload-artifact@v4
        with:
          name: project-auto-status-debug-prs
          path: |
            debug/*.json
          if-no-files-found: ignore
          retention-days: 1

  reconcile:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: gh version
        run: gh --version
      - name: Debug auth & validate PAT
        run: |
          echo "ðŸ”‘ Checking GitHub authentication"
          gh auth status -h github.com || true

          TOKEN="$(gh auth token)"
          SCOPES=$(curl -s -H "Authorization: token $TOKEN" https://api.github.com/user -i | awk -F': ' '/^x-oauth-scopes:/ {print $2}' | tr -d '\r')
          USER_LOGIN=$(curl -s -H "Authorization: token $TOKEN" https://api.github.com/user | jq -r .login)
          echo "x-oauth-scopes: ${SCOPES:-<none>}"
          echo "ðŸ‘¤ Active user: $USER_LOGIN"

          if [ "$USER_LOGIN" != "Arkon-Meyer" ]; then
            echo "::error::Token is for '$USER_LOGIN' but expected 'Arkon-Meyer'."
            echo "::notice::To regenerate: Settings â†’ Developer settings â†’ Personal access tokens â†’ Fine-grained token"
            echo "::notice::Grant: repos (this repo), scopes: repo, project, workflow. Name it GH_PAT and add to repo secrets."
            exit 1
          fi

          echo "$SCOPES" | grep -qi 'project' || {
            echo "::error::Token missing 'project' scope."
            echo "::notice::To regenerate: create a fine-grained PAT with 'project' and 'repo' access, save as GH_PAT."
            exit 1
          }

      - name: Reconcile board (titles â†’ Status)
        env:
          DEBUG: ${{ inputs.debug || '' }}
        run: |
          chmod +x scripts/project-set-status.sh
          scripts/project-set-status.sh
      - name: Upload debug (optional)
        if: env.DEBUG == '1'
        uses: actions/upload-artifact@v4
        with:
          name: project-auto-status-debug-reconcile
          path: |
            debug/*.json
          if-no-files-found: ignore
          retention-days: 1
