name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

# Avoid duplicate runs
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# Allow actionlint to annotate PRs
permissions:
  contents: read
  pull-requests: read
  checks: write

jobs:
  actionlint:
    name: actionlint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: actionlint
        uses: reviewdog/action-actionlint@v1
        with:
          actionlint_flags: -color
          reporter: github-check
          level: warning

  install_lockfile:
    name: install & lockfile sanity
    needs: actionlint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Clean install (no lifecycle scripts)
        run: npm ci --ignore-scripts

  migrate_seed:
    name: db migrate & seed
    needs: install_lockfile
    runs-on: ubuntu-latest
    timeout-minutes: 6
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: app
        ports: ["5432:5432"]
        options: >-
          --health-cmd="pg_isready -U postgres -d app"
          --health-interval=5s --health-timeout=5s --health-retries=20
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/app
      POSTINSTALL_SKIP_SMOKE: '1'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci --ignore-scripts
      - name: Run migrations + seed (skip postinstall smoke)
        run: |
          npm run migrate
          npm run seed

  smoke:
    name: smoke (aggregate + detail)
    needs: migrate_seed
    runs-on: ubuntu-latest
    timeout-minutes: 12
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: app
        ports: ["5432:5432"]
        options: >-
          --health-cmd="pg_isready -U postgres -d app"
          --health-interval=5s --health-timeout=5s --health-retries=20
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/app
      PORT: "3000"
      BASE_URL: "http://127.0.0.1:3000"
      CI: "true"
      POSTINSTALL_SKIP_SMOKE: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci --ignore-scripts
      - name: Start server in background & wait for /healthz
        run: |
          nohup node server.js > server.log 2>&1 & echo $! > server.pid
          for i in {1..30}; do
            curl -fsS "$BASE_URL/healthz" && break
            sleep 1
          done
      - name: Run smoke audit (aggregate)
        run: npm run smoke:audit --quiet
      - name: Run smoke audit (detail)
        run: npm run smoke:audit:detail --quiet
      - name: Show server log on failure
        if: failure()
        run: |
          echo "---- server.log (tail) ----"
          tail -n 200 server.log || true
      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then kill "$(cat server.pid)" || true; fi

  rate_limit_smoke:
    name: rate-limit smoke
    needs: migrate_seed
    runs-on: ubuntu-latest
    timeout-minutes: 6
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: app
        ports: ["5432:5432"]
        options: >-
          --health-cmd="pg_isready -U postgres -d app"
          --health-interval=5s --health-timeout=5s --health-retries=20
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/app
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci --ignore-scripts
      - name: Start server in background & wait for /healthz
        run: |
          nohup node server.js > server.log 2>&1 & echo $! > server.pid
          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/healthz || true)
            [ "$code" = "200" ] && break
            sleep 1
          done
      - name: Burst requests and expect 429s
        run: |
          hits=0
          for i in {1..40}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" -H "X-User-Id: 1" "http://127.0.0.1:3000/audit?mode=aggregate")
            [ "$code" = "429" ] && hits=$((hits+1))
          done
          echo "Saw $hits rate-limit responses"
          [ $hits -ge 5 ] || (echo "Expected some 429s but saw $hits" && exit 1)
      - name: Show server log on failure
        if: failure()
        run: |
          echo "---- server.log (tail) ----"
          tail -n 200 server.log || true
      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then kill "$(cat server.pid)" || true; fi
