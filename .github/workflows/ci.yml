name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read
  checks: write

jobs:
  actionlint:
    name: Lint GitHub Actions
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: actionlint
        uses: reviewdog/action-actionlint@v1
        with:
          actionlint_flags: -color
          reporter: github-check
          level: warning

  smoke:
    name: Node smoke audit
    needs: actionlint
    runs-on: ubuntu-latest
    timeout-minutes: 12
    env:
      PORT: "3000"
      BASE_URL: "http://localhost:3000"
      CI: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # Run migrate+seed during install; skip smoke in postinstall
      - name: Install deps (skip smoke during install)
        env:
          POSTINSTALL_SKIP_SMOKE: "1"
        run: npm ci

      - name: Start server (background) + wait for /healthz
        run: |
          nohup node server.js > server.log 2>&1 & echo $! > server.pid
          for i in {1..30}; do
            curl -fsS "$BASE_URL/healthz" && break
            sleep 1
          done

      - name: Run smoke audit (aggregate)
        run: npm run smoke:audit --quiet

      - name: Run smoke audit (detail)
        run: npm run smoke:audit:detail --quiet

      - name: Show server log on failure
        if: failure()
        run: |
          echo "---- server.log (tail) ----"
          tail -n 200 server.log || true

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then kill $(cat server.pid) || true; fi
