name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

# Avoid duplicate runs on the same ref
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# Enable Checks API so actionlint can report nicely
permissions:
  contents: read
  pull-requests: read
  checks: write

jobs:
  actionlint:
    name: Lint GitHub Actions
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: actionlint
        uses: reviewdog/action-actionlint@v1
        with:
          actionlint_flags: -color
          reporter: github-check
          level: warning

  install_lockfile:
    name: Install & lockfile sanity
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Clean install (no scripts)
        run: npm ci --ignore-scripts

  migrate_seed:
    name: DB migrate & seed
    needs: install_lockfile
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci --ignore-scripts
      - name: Run migrations + seed (no smoke in postinstall)
        env:
          POSTINSTALL_SKIP_SMOKE: '1'
        run: |
          npm run migrate
          npm run seed

  smoke:
    name: Node smoke audit
    needs: [actionlint, migrate_seed]
    runs-on: ubuntu-latest
    timeout-minutes: 12
    env:
      PORT: "3000"
      BASE_URL: "http://localhost:3000"
      CI: "true"
      POSTINSTALL_SKIP_SMOKE: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps (skip smoke during install)
        run: npm ci

      - name: Start server (background) + wait for /healthz
        run: |
          nohup node server.js > server.log 2>&1 & echo $! > server.pid
          ok=""
          for i in {1..30}; do
            if curl -fsS "$BASE_URL/healthz" >/dev/null 2>&1; then ok="yes"; break; fi
            sleep 1
          done
          [ -n "$ok" ] || { echo "API never became healthy" >&2; tail -n +1 server.log || true; exit 1; }

      - name: Run smoke audit (aggregate)
        run: npm run smoke:audit --quiet

      - name: Run smoke audit (detail)
        run: npm run smoke:audit:detail --quiet

      - name: Show server log on failure
        if: failure()
        run: |
          echo "---- server.log (tail) ----"
          tail -n 200 server.log || true

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then kill "$(cat server.pid)" || true; fi

  rate_limit_smoke:
    name: Rate-limit smoke
    needs: migrate_seed
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci --ignore-scripts

      - name: Start server
        run: |
          nohup node server.js > server.log 2>&1 & echo $! > server.pid
          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/healthz || true)
            [ "$code" = "200" ] && break
            sleep 0.5
          done
          [ "$code" = "200" ] || { echo "API never became healthy"; tail -n 200 server.log || true; exit 1; }

      - name: Burst requests and expect 429s
        run: |
          hits=0
          for i in {1..40}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" -H "X-User-Id: 1" "http://127.0.0.1:3000/audit?mode=aggregate")
            [ "$code" = "429" ] && hits=$((hits+1))
          done
          echo "Saw $hits rate-limit responses"
          [ $hits -ge 5 ] || (echo "Expected some 429s but saw $hits" && exit 1)

      - name: Show server log on failure
        if: failure()
        run: tail -n 200 server.log || true

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then kill "$(cat server.pid)" || true; fi

  prod_vuln_audit:
    name: Production vuln audit
    needs: install_lockfile
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci --ignore-scripts
      - name: Audit (fail on high/critical only)
        run: npm audit --omit=dev --audit-level=high
