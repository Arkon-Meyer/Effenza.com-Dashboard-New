name: Secret scan

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Scan for common secrets
        run: |
          set -euo pipefail

          PATTERN='ghp_[A-Za-z0-9]{36,}|GITHUB_TOKEN|NPM[_-]?TOKEN|_authToken|npm\.pkg\.github\.com|GHCR[_-]?TOKEN|AKIA[0-9A-Z]{16}|(?i)aws(.{0,20})?(secret|access)_?key(.{0,20})?[:=][[:space:]]*[^\r\n]+|AIza[0-9A-Za-z\-_]{35}|xox[baprs]-[0-9A-Za-z-]{10,}|-----BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY-----'

          # Search repo, but exclude this workflow (and a few safe files)
          git grep -I -n -E "$PATTERN" -- \
            . \
            ':(exclude).github/workflows/secret-lint.yml' \
            ':(exclude)docs/SECURITY_COMPLIANCE_NOTES.md' \
            ':(exclude)user-*-audit.csv' \
            > secret-scan-results.txt || true

          if [ -s secret-scan-results.txt ]; then
            echo "FOUND_SECRETS=1" >> "$GITHUB_ENV"
            echo "Potential secrets found:"
            cat secret-scan-results.txt
          else
            echo "FOUND_SECRETS=0" >> "$GITHUB_ENV"
            echo "No potential secrets found."
          fi

      - name: Upload results (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-results
          path: secret-scan-results.txt
          if-no-files-found: ignore

      - name: Fail on protected branches (main and PRs to main)
        if: env.FOUND_SECRETS == '1' && (github.ref == 'refs/heads/main' || github.base_ref == 'main')
        run: |
          echo "::error::Potential secrets detected. See job summary and artifact."
          exit 1

      - name: Soft warning on non-protected branches
        if: env.FOUND_SECRETS == '1' && github.ref != 'refs/heads/main' && github.base_ref != 'main'
        run: |
          echo "::warning::Potential secrets detected (non-protected branch). See job summary and artifact."
