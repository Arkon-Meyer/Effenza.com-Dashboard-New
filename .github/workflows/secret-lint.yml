name: Secret scan
on: [push, pull_request]

permissions:
  contents: read

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan for common secrets
        id: scan
        shell: bash
        run: |
          set -euo pipefail
          MATCH_FILE="secret-scan-results.txt"
          : > "$MATCH_FILE"

          # Patterns to catch typical leaks (extend as needed)
          # NOTE: We use -P (Perl regex) for richer patterns.
          read -r -d '' PATTERN <<'REGEX'
ghp_[A-Za-z0-9]{36,}                                   # GitHub classic PAT
|GITHUB_TOKEN                                           # GitHub Actions token (shouldn’t be committed)
|NPM[_-]?TOKEN|_authToken|npm\.pkg\.github\.com        # npm/GHCR tokens
|GHCR[_-]?TOKEN                                        # GHCR tokens
|AKIA[0-9A-Z]{16}                                      # AWS access key id
|(?i)aws(.{0,20})?(secret|access)_?key(.{0,20})?[:=]\s*[^\r\n]+  # AWS secret-style assignments
|AIza[0-9A-Za-z\-_]{35}                                # Google API key
|xox[baprs]-[0-9A-Za-z-]{10,}                          # Slack tokens
|-----BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY-----       # Private key headers
REGEX

          echo "Running secret scan…"
          set +e
          git grep -nP "$PATTERN" \
            -- \
            ':!node_modules' ':!.git' ':!logs' ':!dist' ':!build' ':!coverage' \
            ':!**/*.png' ':!**/*.jpg' ':!**/*.jpeg' ':!**/*.gif' ':!**/*.pdf' \
            > "$MATCH_FILE"
          GREP_STATUS=$?
          set -e

          # git grep exit codes: 0=matches, 1=no matches, 2=error
          if [ "$GREP_STATUS" -eq 2 ]; then
            echo "::error::Secret scan failed to run."
            exit 2
          fi

          COUNT=$(wc -l < "$MATCH_FILE" | tr -d ' ')
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

          if [ "$COUNT" -gt 0 ]; then
            {
              echo "### Potential secrets found ($COUNT)"
              echo
              echo '```'
              # Limit summary size; full results will be in the artifact
              sed -n '1,200p' "$MATCH_FILE"
              echo '```'
              echo
              echo "_(showing first 200 lines; full list is in the artifact)_"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### No potential secrets found ✅" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload results (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-results
          path: secret-scan-results.txt
          if-no-files-found: ignore

      # Fail on main branch and PRs targeting main
      - name: Fail on protected branches (main and PRs to main)
        if: >
          steps.scan.outputs.count != '0' &&
          (github.ref == 'refs/heads/main' ||
           (github.event_name == 'pull_request' && github.base_ref == 'main'))
        run: |
          echo "::error::Potential secrets detected. See job summary and artifact."
          exit 1

      # Only warn on other branches
      - name: Soft warning on non-protected branches
        if: >
          steps.scan.outputs.count != '0' &&
          !(github.ref == 'refs/heads/main' ||
            (github.event_name == 'pull_request' && github.base_ref == 'main'))
        run: echo "::warning::Potential secrets detected (not failing on non-protected branch)."
