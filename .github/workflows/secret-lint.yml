name: Secret scan
on: [push, pull_request]

permissions:
  contents: read

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan for common secrets
        id: scan
        shell: bash
        run: |
          set -euo pipefail
          MATCH_FILE="secret-scan-results.txt"
          : > "$MATCH_FILE"

          # One-line Perl regex (no heredoc): extend as needed
          PATTERN='ghp_[A-Za-z0-9]{36,}|GITHUB_TOKEN|NPM[_-]?TOKEN|_authToken|npm\.pkg\.github\.com|GHCR[_-]?TOKEN|AKIA[0-9A-Z]{16}|(?i)aws(.{0,20})?(secret|access)_?key(.{0,20})?[:=][[:space:]]*[^\r\n]+|AIza[0-9A-Za-z\-_]{35}|xox[baprs]-[0-9A-Za-z-]{10,}|-----BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY-----'

          echo "Running secret scan…"
          set +e
          git grep -nP "$PATTERN" \
            -- \
            ':!node_modules' ':!.git' ':!logs' ':!dist' ':!build' ':!coverage' \
            ':!**/*.png' ':!**/*.jpg' ':!**/*.jpeg' ':!**/*.gif' ':!**/*.pdf' \
            > "$MATCH_FILE"
          GREP_STATUS=$?
          set -e

          # git grep exit codes: 0=matches, 1=no matches, 2=error
          if [ "$GREP_STATUS" -eq 2 ]; then
            echo "::error::Secret scan failed to run."
            exit 2
          fi

          COUNT=$(wc -l < "$MATCH_FILE" | tr -d ' ')
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

          if [ "$COUNT" -gt 0 ]; then
            {
              echo "### Potential secrets found ($COUNT)"
              echo
              echo '```'
              sed -n '1,200p' "$MATCH_FILE"
              echo '```'
              echo
              echo "_(showing first 200 lines; full list is in the artifact)_"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### No potential secrets found ✅" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload results (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-results
          path: secret-scan-results.txt
          if-no-files-found: ignore

      - name: Fail on protected branches (main and PRs to main)
        if: >
          steps.scan.outputs.count != '0' &&
          (github.ref == 'refs/heads/main' ||
           (github.event_name == 'pull_request' && github.base_ref == 'main'))
        run: |
          echo "::error::Potential secrets detected. See job summary and artifact."
          exit 1

      - name: Soft warning on non-protected branches
        if: >
          steps.scan.outputs.count != '0' &&
          !(github.ref == 'refs/heads/main' ||
            (github.event_name == 'pull_request' && github.base_ref == 'main'))
        run: echo "::warning::Potential secrets detected (not failing on non-protected branch)."
